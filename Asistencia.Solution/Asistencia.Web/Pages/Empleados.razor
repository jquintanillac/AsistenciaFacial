@page "/empleados"
@using Asistencia.Shared.DTOs.Requests
@using Asistencia.Shared.DTOs.Responses
@using Asistencia.Web.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IApiService ApiService
@inject IJSRuntime JSRuntime

<PageTitle>Empleados</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Gestión de Empleados</h3>
        <Button Color="ButtonColor.Primary" @onclick="ShowCreateModal">
            <Icon Name="IconName.Plus" /> Nuevo Empleado
        </Button>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <Spinner Color="SpinnerColor.Primary" />
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <Alert Color="AlertColor.Danger" Dismissable="true">@errorMessage</Alert>
    }
    else
    {
        <Grid TItem="EmployeeResponse" Data="empleados" Class="table table-hover table-bordered table-striped" Responsive="true">
            <GridColumns>
                <GridColumn TItem="EmployeeResponse" HeaderText="DNI" PropertyName="DNI" Sortable="true" Context="empleado">
                    @empleado.DNI
                </GridColumn>
                <GridColumn TItem="EmployeeResponse" HeaderText="Nombres" PropertyName="Nombres" Sortable="true" Context="empleado">
                    @empleado.Nombres
                </GridColumn>
                <GridColumn TItem="EmployeeResponse" HeaderText="Apellidos" PropertyName="Apellidos" Sortable="true" Context="empleado">
                    @empleado.Apellidos
                </GridColumn>
                <GridColumn TItem="EmployeeResponse" HeaderText="Cargo" PropertyName="Cargo" Context="empleado" >
                    @empleado.Cargo
                </GridColumn>
                <GridColumn TItem="EmployeeResponse" HeaderText="Empresa" Context="item">
                    @GetEmpresaName(item.IdEmpresa)
                </GridColumn>
                <GridColumn TItem="EmployeeResponse" HeaderText="Estado" Context="item">
                    <Badge Color="@(item.Estado ? BadgeColor.Success : BadgeColor.Secondary)">
                        @(item.Estado ? "Activo" : "Inactivo")
                    </Badge>
                </GridColumn>
                <GridColumn TItem="EmployeeResponse" HeaderText="Acciones" Context="item">
                    <Button Color="ButtonColor.Warning" Size="ButtonSize.Small" @onclick="() => ShowEditModal(item)" Class="me-2" TooltipTitle="Editar">
                        <Icon Name="IconName.Pencil" />
                    </Button>
                    <Button Color="ButtonColor.Danger" Size="ButtonSize.Small" @onclick="() => DeleteEmpleado(item.IdEmpleado)" TooltipTitle="Eliminar">
                        <Icon Name="IconName.Trash" />
                    </Button>
                </GridColumn>
            </GridColumns>
        </Grid>
    }
</div>

<Modal @ref="modal" Title="@(isEditing ? "Editar Empleado" : "Nuevo Empleado")" IsVerticallyCentered="true" Size="ModalSize.Large">
    <BodyTemplate>
        <EditForm Model="@currentEmpleado" OnValidSubmit="SaveEmpleado">
            <DataAnnotationsValidator />
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Empresa</label>
                    <InputSelect class="form-select" @bind-Value="currentEmpleado.IdEmpresa">
                        <option value="0">-- Seleccione Empresa --</option>
                        @foreach (var emp in empresas)
                        {
                            <option value="@emp.IdEmpresa">@emp.RazonSocial</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => currentEmpleado.IdEmpresa)" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">DNI</label>
                    <InputText class="form-control" @bind-Value="currentEmpleado.DNI" />
                    <ValidationMessage For="@(() => currentEmpleado.DNI)" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nombres</label>
                    <InputText class="form-control" @bind-Value="currentEmpleado.Nombres" />
                    <ValidationMessage For="@(() => currentEmpleado.Nombres)" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Apellidos</label>
                    <InputText class="form-control" @bind-Value="currentEmpleado.Apellidos" />
                    <ValidationMessage For="@(() => currentEmpleado.Apellidos)" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Cargo</label>
                    <InputText class="form-control" @bind-Value="currentEmpleado.Cargo" />
                    <ValidationMessage For="@(() => currentEmpleado.Cargo)" />
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                <Button Type="ButtonType.Button" Color="ButtonColor.Secondary" @onclick="CloseModal">Cancelar</Button>
                <Button Type="ButtonType.Submit" Color="ButtonColor.Success">Guardar</Button>
            </div>
        </EditForm>
    </BodyTemplate>
</Modal>

@code {
    private IEnumerable<EmployeeResponse> empleados = new List<EmployeeResponse>();
    private IEnumerable<EmpresaResponse> empresas = new List<EmpresaResponse>();
    private UpdateEmployeeRequest currentEmpleado = new();
    
    private bool isLoading = true;
    private bool isEditing = false;
    private string? errorMessage;
    private Modal modal = default!;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try 
        {
            var resultEmpresas = await ApiService.GetAsync<IEnumerable<EmpresaResponse>>("api/Empresa");
            if (resultEmpresas.IsSuccess)
                empresas = resultEmpresas.Value!;

            var resultEmpleados = await ApiService.GetAsync<IEnumerable<EmployeeResponse>>("api/Employee");
            if (resultEmpleados.IsSuccess)
                empleados = resultEmpleados.Value!;
            else
                errorMessage = resultEmpleados.Error;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        isLoading = false;
    }

    private string GetEmpresaName(int idEmpresa)
    {
        var empresa = empresas.FirstOrDefault(e => e.IdEmpresa == idEmpresa);
        return empresa?.RazonSocial ?? "Desconocida";
    }

    private async Task ShowCreateModal()
    {
        currentEmpleado = new UpdateEmployeeRequest();
        isEditing = false;
        errorMessage = null;
        await modal.ShowAsync();
    }

    private async Task ShowEditModal(EmployeeResponse empleado)
    {
        currentEmpleado = new UpdateEmployeeRequest
        {
            IdEmpleado = empleado.IdEmpleado,
            IdEmpresa = empleado.IdEmpresa,
            DNI = empleado.DNI,
            Nombres = empleado.Nombres,
            Apellidos = empleado.Apellidos,
            Cargo = empleado.Cargo
        };
        isEditing = true;
        errorMessage = null;
        await modal.ShowAsync();
    }

    private async Task CloseModal()
    {
        await modal.HideAsync();
        currentEmpleado = new();
        errorMessage = null;
    }

    private async Task SaveEmpleado()
    {
        isLoading = true;
        errorMessage = null;
        bool success = false;

        if (isEditing)
        {
            var result = await ApiService.PutAsync<bool>($"api/Employee/{currentEmpleado.IdEmpleado}", currentEmpleado);
            if (!result.IsSuccess) 
                errorMessage = result.Error;
            else
                success = true;
        }
        else
        {
            var createRequest = new CreateEmployeeRequest
            {
                IdEmpresa = currentEmpleado.IdEmpresa,
                DNI = currentEmpleado.DNI,
                Nombres = currentEmpleado.Nombres,
                Apellidos = currentEmpleado.Apellidos,
                Cargo = currentEmpleado.Cargo
            };
            
            var result = await ApiService.PostAsync<EmployeeResponse>("api/Employee", createRequest);
            if (!result.IsSuccess)
                errorMessage = result.Error;
            else
                success = true;
        }

        isLoading = false;
        if (success)
        {
            await CloseModal();
            await LoadData();
        }
    }

    private async Task DeleteEmpleado(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "¿Está seguro de eliminar este empleado?"))
        {
            var result = await ApiService.DeleteAsync($"api/Employee/{id}");
            if (result.IsSuccess)
            {
                await LoadData();
            }
            else
            {
                errorMessage = result.Error;
            }
        }
    }
}
