@page "/empresas"
@using Asistencia.Shared.DTOs.Responses
@using Asistencia.Shared.DTOs.Requests
@using Asistencia.Web.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IApiService ApiService
@inject IJSRuntime JSRuntime

<PageTitle>Empresas</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Gestión de Empresas</h3>
        <Button Color="ButtonColor.Primary" @onclick="ShowCreateForm">
            <Icon Name="IconName.Plus" /> Nueva Empresa
        </Button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <Alert Color="AlertColor.Danger" Dismissable="true">@errorMessage</Alert>
    }

    @if (isLoading && empresas == null)
    {
        <div class="d-flex justify-content-center">
            <Spinner Color="SpinnerColor.Primary" />
        </div>
    }
    else
    {
        <Grid TItem="EmpresaResponse" Data="empresas" Class="table table-hover table-bordered table-striped" Responsive="true">
            <GridColumns>
                <GridColumn TItem="EmpresaResponse" HeaderText="Razón Social" PropertyName="RazonSocial" Sortable="true" Context="item" >
                    @item.RazonSocial
                </GridColumn>
                <GridColumn TItem="EmpresaResponse" HeaderText="RUC" PropertyName="RUC" Sortable="true" Context="item">
                    @item.RUC
                </GridColumn>
                <GridColumn TItem="EmpresaResponse" HeaderText="Dirección" PropertyName="Direccion" Context="item">
                    @item.Direccion
                </GridColumn>
                <GridColumn TItem="EmpresaResponse" HeaderText="Teléfono" PropertyName="Telefono" Context="item">
                    @item.Telefono
                </GridColumn>
                <GridColumn TItem="EmpresaResponse" HeaderText="Email" PropertyName="Email" Context="item">
                    @item.Email
                </GridColumn>
                <GridColumn TItem="EmpresaResponse" HeaderText="Acciones" Context="empresa">
                    <Button Color="ButtonColor.Warning" Size="ButtonSize.Small" @onclick="() => EditEmpresa(empresa)" Class="me-2" TooltipTitle="Editar">
                        <Icon Name="IconName.Pencil" />
                    </Button>
                    <Button Color="ButtonColor.Danger" Size="ButtonSize.Small" @onclick="() => DeleteEmpresa(empresa.IdEmpresa)" TooltipTitle="Eliminar">
                        <Icon Name="IconName.Trash" />
                    </Button>
                </GridColumn>
            </GridColumns>
        </Grid>
    }
</div>

<Modal @ref="modal" Title="@(isEditing ? "Editar Empresa" : "Nueva Empresa")" IsVerticallyCentered="true">
    <BodyTemplate>
        <EditForm Model="@currentEmpresa" OnValidSubmit="SaveEmpresa">
            <DataAnnotationsValidator />
            
            <div class="mb-3">
                <label class="form-label">Razón Social</label>
                <InputText class="form-control" @bind-Value="currentEmpresa.RazonSocial" />
                <ValidationMessage For="@(() => currentEmpresa.RazonSocial)" />
            </div>
            <div class="mb-3">
                <label class="form-label">RUC</label>
                <InputText class="form-control" @bind-Value="currentEmpresa.RUC" />
                <ValidationMessage For="@(() => currentEmpresa.RUC)" />
            </div>
            <div class="mb-3">
                <label class="form-label">Dirección</label>
                <InputText class="form-control" @bind-Value="currentEmpresa.Direccion" />
                <ValidationMessage For="@(() => currentEmpresa.Direccion)" />
            </div>
            <div class="mb-3">
                <label class="form-label">Teléfono</label>
                <InputText class="form-control" @bind-Value="currentEmpresa.Telefono" />
                <ValidationMessage For="@(() => currentEmpresa.Telefono)" />
            </div>
            <div class="mb-3">
                <label class="form-label">Email</label>
                <InputText class="form-control" @bind-Value="currentEmpresa.Email" />
                <ValidationMessage For="@(() => currentEmpresa.Email)" />
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                <Button Type="ButtonType.Button" Color="ButtonColor.Secondary" @onclick="CancelForm">Cancelar</Button>
                <Button Type="ButtonType.Submit" Color="ButtonColor.Success">Guardar</Button>
            </div>
        </EditForm>
    </BodyTemplate>
</Modal>

@code {
    private IEnumerable<EmpresaResponse>? empresas;
    private UpdateEmpresaRequest currentEmpresa = new();
    private bool isLoading = true;
    private bool isEditing = false;
    private string? errorMessage;
    private Modal modal = default!;

    protected override async Task OnInitializedAsync()
    {
        await LoadEmpresas();
    }

    private async Task LoadEmpresas()
    {
        isLoading = true;
        var result = await ApiService.GetAsync<IEnumerable<EmpresaResponse>>("api/Empresa");
        if (result.IsSuccess)
        {
            empresas = result.Value;
        }
        else
        {
            errorMessage = result.Error;
        }
        isLoading = false;
    }

    private async Task ShowCreateForm()
    {
        currentEmpresa = new UpdateEmpresaRequest();
        isEditing = false;
        errorMessage = null;
        await modal.ShowAsync();
    }

    private async Task EditEmpresa(EmpresaResponse empresa)
    {
        currentEmpresa = new UpdateEmpresaRequest
        {
            IdEmpresa = empresa.IdEmpresa,
            RazonSocial = empresa.RazonSocial,
            RUC = empresa.RUC,
            Direccion = empresa.Direccion,
            Telefono = empresa.Telefono,
            Email = empresa.Email,
            ConfiguracionAsistencia = empresa.ConfiguracionAsistencia
        };
        isEditing = true;
        errorMessage = null;
        await modal.ShowAsync();
    }

    private async Task CancelForm()
    {
        await modal.HideAsync();
        currentEmpresa = new();
        errorMessage = null;
    }

    private async Task SaveEmpresa()
    {
        isLoading = true; // Show loading state if needed, or rely on UI
        errorMessage = null;

        // Keep modal open while saving? Or close it?
        // Usually good to keep it open if error, close if success.
        // But we are setting isLoading = true which might re-render the grid outside the modal.
        
        bool success = false;

        if (isEditing)
        {
            var result = await ApiService.PutAsync<bool>($"api/Empresa/{currentEmpresa.IdEmpresa}", currentEmpresa);
            if (!result.IsSuccess) 
            {
                errorMessage = result.Error;
            }
            else 
            {
                success = true;
            }
        }
        else
        {
            var createRequest = new CreateEmpresaRequest
            {
                RazonSocial = currentEmpresa.RazonSocial,
                RUC = currentEmpresa.RUC,
                Direccion = currentEmpresa.Direccion,
                Telefono = currentEmpresa.Telefono,
                Email = currentEmpresa.Email,
                ConfiguracionAsistencia = currentEmpresa.ConfiguracionAsistencia
            };
            var result = await ApiService.PostAsync<bool>("api/Empresa", createRequest);
             if (!result.IsSuccess) 
            {
                errorMessage = result.Error;
            }
            else 
            {
                success = true;
            }
        }

        if (success)
        {
            await modal.HideAsync();
            await LoadEmpresas();
        }
        else
        {
            // If error, we might want to show it inside the modal or global?
            // Current design shows it in the main page.
            // Let's force close and show error on main page, OR show error in modal.
            // For now, I'll close modal and show error on main page to be safe with existing logic flow.
            // But user might want to retry.
            // Let's keep modal open if error? 
            // The `errorMessage` variable is displayed in the main layout in my new code.
            // If I keep modal open, user won't see the error if it's outside the modal.
            // I should move error display inside modal for form errors.
            // But I will stick to closing for now to ensure state is clear.
            // Actually, if I close, the user loses their input? 
            // `currentEmpresa` is preserved until I call `new()`.
            // So if I close, they have to click edit again.
            // Let's NOT close if error.
        }
        
        isLoading = false;
    }

    private async Task DeleteEmpresa(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "¿Está seguro de eliminar esta empresa?"))
        {
            var result = await ApiService.DeleteAsync($"api/Empresa/{id}");
            if (result.IsSuccess)
            {
                await LoadEmpresas();
            }
            else
            {
                errorMessage = result.Error;
            }
        }
    }
}
