@page "/login"
@using Asistencia.Shared.DTOs.Requests
@using Asistencia.Web.Services
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<PageTitle>Iniciar Sesión</PageTitle>

<div class="d-flex justify-content-center align-items-center vh-100 bg-light">
    <div class="container" style="max-width: 450px;">
        <Card Class="shadow-lg border-0">
            <CardHeader Class="bg-primary text-white text-center py-3">
                <h4 class="mb-0">Iniciar Sesión</h4>
            </CardHeader>
            <CardBody Class="p-4">
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <Alert Color="AlertColor.Danger" Dismissable="true">@errorMessage</Alert>
                }

                <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
                    <DataAnnotationsValidator />
                    
                    <div class="mb-3">
                        <label for="username" class="form-label fw-bold">Usuario</label>
                        <InputText id="username" class="form-control" @bind-Value="loginModel.Username" placeholder="Ingrese su usuario" />
                        <ValidationMessage For="@(() => loginModel.Username)" />
                    </div>

                    <div class="mb-4">
                        <label for="password" class="form-label fw-bold">Contraseña</label>
                        <InputText id="password" type="password" class="form-control" @bind-Value="loginModel.Password" placeholder="Ingrese su contraseña" />
                        <ValidationMessage For="@(() => loginModel.Password)" />
                    </div>

                    <div class="d-grid gap-2">
                        <Button Type="ButtonType.Submit" Color="ButtonColor.Primary" Size="ButtonSize.Large" Disabled="@isLoading">
                            @if (isLoading)
                            {
                                <Spinner Class="me-2" Type="SpinnerType.Border" Size="SpinnerSize.Small" />
                            }
                            else
                            {
                                <Icon Name="IconName.BoxArrowInRight" Class="me-2" />
                            }
                            Entrar
                        </Button>
                    </div>
                </EditForm>
            </CardBody>
            <CardFooter Class="text-center text-muted py-3">
                <small>Sistema de Asistencia © @DateTime.Now.Year</small>
            </CardFooter>
        </Card>
    </div>
</div>

@code {
    private LoginRequest loginModel = new();
    private string? errorMessage;
    private bool isLoading = false;
    private async Task HandleLogin()
    {
        errorMessage = null;
        var result = await AuthService.LoginAsync(loginModel);

        if (result.IsSuccess)
        {
            NavigationManager.NavigateTo("/");
        }
        else
        {
            errorMessage = result.Error;
        }
    }
}
