@page "/roles"
@using Asistencia.Shared.DTOs.Requests
@using Asistencia.Shared.DTOs.Responses
@using Asistencia.Web.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IApiService ApiService
@inject IJSRuntime JSRuntime

<PageTitle>Roles</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Gestión de Roles</h2>
        <Button Color="ButtonColor.Primary" @onclick="ShowCreateModal">
            <Icon Name="IconName.Plus" /> Nuevo Rol
        </Button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <Alert Color="AlertColor.Danger" Dismissable="true" @onclick="() => errorMessage = null">@errorMessage</Alert>
    }

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <Spinner Color="SpinnerColor.Primary" />
        </div>
    }
    else
    {
        <Grid TItem="RolResponse" Data="roles" Class="table table-hover table-bordered table-striped" Responsive="true">
            <GridColumns>
                <GridColumn TItem="RolResponse" HeaderText="Nombre" PropertyName="Nombre" Sortable="true">
                    @context.Nombre
                </GridColumn>
                <GridColumn TItem="RolResponse" HeaderText="Descripción" PropertyName="Descripcion">
                    @context.Descripcion
                </GridColumn>
                <GridColumn TItem="RolResponse" HeaderText="Acciones" Context="item">
                    <Button Color="ButtonColor.Warning" Size="ButtonSize.Small" @onclick="() => ShowEditModal(item)" Class="me-2" TooltipTitle="Editar">
                        <Icon Name="IconName.Pencil" />
                    </Button>
                    <Button Color="ButtonColor.Danger" Size="ButtonSize.Small" @onclick="() => DeleteRol(item.IdRol)" TooltipTitle="Eliminar">
                        <Icon Name="IconName.Trash" />
                    </Button>
                </GridColumn>
            </GridColumns>
        </Grid>
    }
</div>

<Modal @ref="modal" Title="@(isEditing ? "Editar Rol" : "Nuevo Rol")" IsVerticallyCentered="true">
    <BodyTemplate>
        <EditForm Model="@currentRol" OnValidSubmit="SaveRol">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-3">
                <label class="form-label">Nombre</label>
                <InputText class="form-control" @bind-Value="currentRol.Nombre" />
            </div>

            <div class="mb-3">
                <label class="form-label">Descripción</label>
                <InputTextArea class="form-control" @bind-Value="currentRol.Descripcion" />
            </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                <Button Type="ButtonType.Button" Color="ButtonColor.Secondary" @onclick="HideModal">Cancelar</Button>
                <Button Type="ButtonType.Submit" Color="ButtonColor.Success">Guardar</Button>
            </div>
        </EditForm>
    </BodyTemplate>
</Modal>

@code {
    private List<RolResponse> roles = new();
    private UpdateRolRequest currentRol = new();
    private bool isLoading = true;
    private string? errorMessage;
    private bool isEditing = false;
    private Modal modal = default!;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var result = await ApiService.GetAsync<List<RolResponse>>("api/Rol");
            if (result.IsSuccess)
            {
                roles = result.Value ?? new List<RolResponse>();
            }
            else
            {
                errorMessage = result.Error;
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ShowCreateModal()
    {
        currentRol = new UpdateRolRequest();
        isEditing = false;
        errorMessage = null;
        await modal.ShowAsync();
    }

    private async Task ShowEditModal(RolResponse rol)
    {
        currentRol = new UpdateRolRequest
        {
            IdRol = rol.IdRol,
            Nombre = rol.Nombre,
            Descripcion = rol.Descripcion
        };
        isEditing = true;
        errorMessage = null;
        await modal.ShowAsync();
    }

    private async Task HideModal()
    {
        await modal.HideAsync();
    }

    private async Task SaveRol()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            if (isEditing)
            {
                var result = await ApiService.PutAsync<bool>($"api/Rol/{currentRol.IdRol}", currentRol);
                if (!result.IsSuccess) errorMessage = result.Error;
            }
            else
            {
                var createRequest = new CreateRolRequest
                {
                    Nombre = currentRol.Nombre,
                    Descripcion = currentRol.Descripcion
                };
                var result = await ApiService.PostAsync<RolResponse>("api/Rol", createRequest);
                if (!result.IsSuccess) errorMessage = result.Error;
            }

            if (string.IsNullOrEmpty(errorMessage))
            {
                await HideModal();
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task DeleteRol(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "¿Está seguro de eliminar este rol?"))
        {
            isLoading = true;
            try
            {
                var result = await ApiService.DeleteAsync($"api/Rol/{id}");
                if (result.IsSuccess)
                {
                    await LoadData();
                }
                else
                {
                    errorMessage = result.Error;
                }
            }
            catch (Exception ex)
            {
                errorMessage = ex.Message;
            }
            finally
            {
                isLoading = false;
            }
        }
    }
}
